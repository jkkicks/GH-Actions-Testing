# üöÄ Full-Scale CI/CD & GitOps Plan

This document outlines the comprehensive CI/CD strategy for the application, integrating **GitOps**, **Automated Migrations**, **Security Scanning**, and **Quality Assurance**.

---

## üèóÔ∏è Architecture Overview

*   **Source Control**: GitHub
*   **CI Provider**: GitHub Actions
*   **Registry**: GitHub Container Registry (GHCR)
*   **Deployment**: DOCO-CD (GitOps) on AWS EC2
*   **Infrastructure**: Terraform (Provisioning) + Ansible (Config & Secrets)
*   **Database**: Postgres (managed via Drizzle ORM)

---

## üîÑ The Workflow

### 1. Developer Workflow (Pull Request)
**Trigger**: Open/Update PR to `main`

1.  **Quality Checks**:
    *   `npm run lint`: Ensure code style.
    *   `npm run typecheck`: Validate TypeScript types.
2.  **Schema & Migration Verification**:
    *   **Drift Check**: `npx drizzle-kit check` fails if `schema.ts` changes exist without a corresponding migration file.
    *   **Migration Test**: Spin up a temporary Postgres service container and run `npx drizzle-kit migrate` to ensure migrations apply cleanly from scratch.
3.  **Security Scan**:
    *   Run **Trivy** fs scan on the codebase for dependency vulnerabilities.

### 2. Staging Deployment (Merge to Main)
**Trigger**: Push to `main`

1.  **Build & Push**:
    *   Build Docker image for `linux/amd64`.
    *   **Optimization**: Use GitHub Actions Cache (`type=gha`) to speed up builds.
    *   **Tagging**: Tag with `sha-<commit-hash>` and `latest`.
    *   Push to GHCR.
2.  **Security Scan (Image)**:
    *   Run **Trivy** image scan on the built artifact.
3.  **Deploy to Staging**:
    *   Update `staging/docker-compose.yml` in the **Infra Repo** with the new image tag.
    *   **DOCO-CD** detects the change and deploys to the Staging Environment.
    *   **GitHub Environment**: Report "Deployed to Staging" status on the commit.

### 3. Production Release (Tag Promotion)
**Trigger**: Create Release Tag (e.g., `v1.2.0`) via Release Please

*   **Prerequisite**: Release Please opens a PR that updates `CHANGELOG.md` AND bumps the version in `package.json`. When this PR is merged, the tag is created.
1.  **Promote Image**:
    *   Pull the existing `sha-<commit>` image from Staging (which was built from the merged code containing the new `package.json` version).
    *   Retag as `v1.2.0`.
    *   Push `v1.2.0` to GHCR.
2.  **Deploy to Production**:
    *   Update `prod/docker-compose.yml` in the **Infra Repo** with tag `v1.2.0`.
    *   **DOCO-CD** detects the change and deploys to the Production Environment.
    *   **GitHub Environment**: Report "Deployed to Production" status.

---

## üõ°Ô∏è Database Migration Strategy

**Principle**: Migrations are generated by developers, verified by CI, and applied by the deployment.

1.  **Generation (Local)**:
    *   Dev changes `schema.ts`.
    *   Dev runs `npm run db:generate`.
    *   Migration SQL files are committed to Git.
2.  **Verification (CI)**:
    *   CI ensures `schema.ts` matches migration files (Drift Check).
    *   CI tests applying migrations to a throwaway DB.
3.  **Execution (Deploy)**:
    *   **Runtime**: The production container runs `npm run db:migrate` **at startup** (CMD/Entrypoint) before starting the app server.
    *   **Safety**: This ensures code and schema are always in sync on the deployed environment.

---

## üìù Configuration Details

### Dockerfile
*   **Base**: `node:20-slim`
*   **Security**: Run as non-root `nodejs` user.
*   **Assets**: Copy `drizzle` folder and `migrations` for runtime execution.
*   **Env**: Accept `ARG` for build-time variables (e.g., `VITE_PUBLIC_*`).

### GitHub Actions (`.github/workflows/build.yml`)
*   **Permissions**: `contents: read`, `packages: write`, `id-token: write`
*   **Concurrency**: Cancel in-progress builds for the same branch.
*   **Caching**: Aggressive Docker layer caching.

### Secrets Management
*   **CI**: `GITHUB_TOKEN` for registry auth.
*   **Runtime**: `.env` files managed by **Ansible** on the EC2 host. DOCO-CD does not manage secrets, only the container versions.

---

## ‚úÖ Checklist for Implementation

- [ ] **Repo**: Configure `drizzle-kit check` and migration scripts.
- [ ] **Docker**: Update `Dockerfile` to include migration files and use non-root user.
- [ ] **CI**: Create `.github/workflows/build.yml` with:
    - [ ] Lint/Typecheck
    - [ ] Migration Verification (Service Container)
    - [ ] Trivy Scan
    - [ ] Build & Push (AMD64, Caching)
    - [ ] Deployment Status (Environments)
- [ ] **Infra**: Ensure DOCO-CD is running and watching the Infra Repo.
